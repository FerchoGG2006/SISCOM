// SISCOM Database Schema (SQLite Version)

generator client {
  provider   = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 1. Tabla de Personas (Unificada)
model Persona {
  id               Int      @id @default(autoincrement())
  tipo_documento   String   // 'CC', 'TI', 'CE', 'RC', 'PPT', 'Otro'
  numero_documento String   @unique
  nombres          String
  apellidos        String
  fecha_nacimiento String?  // SQLite guarda fechas como TEXT (ISO8601)
  genero           String?  // 'Femenino', 'Masculino', 'No Binario', 'Otro'
  ocupacion        String?
  escolaridad      String?
  telefono         String?
  direccion        String?
  barrio           String?
  comuna           String?
  es_victima       Boolean  @default(false)
  es_agresor       Boolean  @default(false)
  created_at       DateTime @default(now())

  expedientesVictima Expediente[] @relation("Victima")
  expedientesAgresor Expediente[] @relation("Agresor")

  @@map("personas")
}

// 2. Tabla de Expedientes
model Expediente {
  id               Int      @id @default(autoincrement())
  radicado_hs      String   @unique // Ej: HS-2026-001
  id_victima       Int
  id_agresor       Int?
  fecha_radicacion DateTime @default(now())
  relato_hechos    String?
  estado           String   @default("Abierto") // 'Abierto', 'En Medidas', 'Cerrado'
  
  // Resultados Riesgo
  puntaje_riesgo   Int      @default(0)
  nivel_riesgo     String   @default("Bajo") // 'Bajo', 'Moderado', 'Crítico'
  
  // Firmas (Hashes o rutas)
  firma_victima    String?
  firma_funcionario String?
  
  // Google Drive ID
  drive_folder_id  String?
  
  victima       Persona @relation("Victima", fields: [id_victima], references: [id])
  agresor       Persona? @relation("Agresor", fields: [id_agresor], references: [id])
  evaluaciones  EvaluacionRiesgo[]
  actuaciones   Actuacion[]
  documentos    Documento[]
  audiencias    Audiencia[]

  @@map("expedientes")
}

// 7. Tabla de Audiencias
model Audiencia {
  id               Int      @id @default(autoincrement())
  id_expediente    Int
  fecha_programada DateTime
  lugar            String   @default("Sala de Audiencias Comisaría")
  estado           String   @default("Programada") // 'Programada', 'Realizada', 'Cancelada'
  observaciones    String?
  notificado       Boolean  @default(false)
  created_at       DateTime @default(now())

  expediente Expediente @relation(fields: [id_expediente], references: [id])

  @@map("audiencias")
}

// 3. Tabla de Evaluaciones
model EvaluacionRiesgo {
  id               Int      @id @default(autoincrement())
  id_expediente    Int
  pregunta_numero  Int
  respuesta        Boolean  @default(false)
  valor_asignado   Int      @default(0)
  categoria        String?
  
  expediente Expediente @relation(fields: [id_expediente], references: [id])

  @@map("evaluaciones_riesgo")
}

// 4. Tabla de Actuaciones (Timeline)
model Actuacion {
  id               Int      @id @default(autoincrement())
  id_expediente    Int
  id_usuario       Int
  fecha            DateTime @default(now())
  tipo             String   // 'Radicación', 'Medida de Protección', 'Audiencia', 'Cierre'
  descripcion      String
  
  expediente Expediente @relation(fields: [id_expediente], references: [id])
  usuario    Usuario    @relation(fields: [id_usuario], references: [id])

  @@map("actuaciones")
}

// 5. Tabla de Documentos
model Documento {
  id               Int      @id @default(autoincrement())
  id_expediente    Int
  nombre           String
  tipo             String   // 'Auto de Inicio', 'Medida', 'Oficio'
  url_drive        String?
  generado_el      DateTime @default(now())
  
  expediente Expediente @relation(fields: [id_expediente], references: [id])

  @@map("documentos")
}

// 6. Tabla de Usuarios (Sistema)
model Usuario {
  id               Int      @id @default(autoincrement())
  nombres          String
  apellidos        String
  email            String   @unique
  password         String
  rol              String   @default("auxiliar")
  cargo            String?
  activo           Boolean  @default(true)
  ultimo_acceso    DateTime?
  created_at       DateTime @default(now())
  
  actuaciones      Actuacion[]

  @@map("usuarios")
}


